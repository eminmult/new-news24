<?php

require __DIR__.'/vendor/autoload.php';

$app = require_once __DIR__.'/bootstrap/app.php';
$app->make('Illuminate\Contracts\Console\Kernel')->bootstrap();

use App\Models\Post;
use App\Models\Category;
use App\Models\Author;
use App\Models\PostType;
use App\Models\Tag;
use Carbon\Carbon;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;

// Получаем категории, авторов и типы
$categories = Category::all();
$authors = Author::all();
$postTypes = PostType::all();

if ($categories->isEmpty() || $authors->isEmpty() || $postTypes->isEmpty()) {
    echo "Ошибка: нет категорий, авторов или типов постов\n";
    exit(1);
}

// Создаем или получаем теги
$tags = [];
$tagNames = ['политика', 'экономика', 'спорт', 'культура', 'технологии', 'наука', 'общество', 'мир', 'бизнес', 'инновации'];
foreach ($tagNames as $tagName) {
    $tag = Tag::firstOrCreate(
        ['slug' => Str::slug($tagName)],
        ['name' => $tagName]
    );
    $tags[] = $tag;
}

// Картинки для постов
$images = [
    'news' => [
        ['name' => 'Президент на встрече', 'width' => 1920, 'height' => 1080],
        ['name' => 'Правительственное здание', 'width' => 1600, 'height' => 900],
        ['name' => 'Пресс-конференция', 'width' => 1920, 'height' => 1280],
    ],
    'culture' => [
        ['name' => 'Культурный центр', 'width' => 1920, 'height' => 1080],
        ['name' => 'Концертный зал', 'width' => 1600, 'height' => 900],
        ['name' => 'Выставка искусства', 'width' => 1920, 'height' => 1280],
        ['name' => 'Мугам концерт', 'width' => 1920, 'height' => 1080],
    ],
    'sport' => [
        ['name' => 'Футбольный стадион', 'width' => 1920, 'height' => 1080],
        ['name' => 'Спортивная команда', 'width' => 1600, 'height' => 900],
    ],
    'tech' => [
        ['name' => 'Современные технологии', 'width' => 1920, 'height' => 1080],
        ['name' => 'IT офис', 'width' => 1600, 'height' => 900],
        ['name' => 'Инновационный центр', 'width' => 1920, 'height' => 1280],
    ],
    'nature' => [
        ['name' => 'Весенний пейзаж', 'width' => 1920, 'height' => 1080],
        ['name' => 'Цветущие деревья', 'width' => 1600, 'height' => 900],
        ['name' => 'Горы Азербайджана', 'width' => 1920, 'height' => 1280],
    ],
    'city' => [
        ['name' => 'Панорама Баку', 'width' => 1920, 'height' => 1080],
        ['name' => 'Пламенные башни', 'width' => 1600, 'height' => 900],
        ['name' => 'Улицы старого города', 'width' => 1920, 'height' => 1280],
        ['name' => 'Приморский бульвар', 'width' => 1920, 'height' => 1080],
    ],
];

// 15 уникальных постов
$testPosts = [
    [
        'title' => 'Азербайджан укрепляет торговые связи со странами Центральной Азии',
        'content' => '<p>Министр экономики провел серию встреч с представителями пяти стран Центральной Азии. Обсуждались перспективы развития торгового сотрудничества и создания совместных предприятий.</p><p>По итогам переговоров подписано несколько меморандумов о взаимопонимании. Особое внимание уделено сотрудничеству в сфере энергетики, транспорта и сельского хозяйства.</p><p>Эксперты оценивают потенциал роста товарооборота на 30-40% в ближайшие два года.</p>',
        'types' => ['Новость'],
        'tags' => ['политика', 'экономика'],
        'is_featured' => true,
        'show_in_slider' => true,
        'img_category' => 'news',
    ],
    [
        'title' => 'Бакинский джазовый фестиваль открывается концертом мировых звезд',
        'content' => '<p>Один из крупнейших джазовых фестивалей региона стартует в Баку. В течение недели столицу посетят известные музыканты из 20 стран мира.</p><p>Организаторы подготовили насыщенную программу: концерты, мастер-классы, джем-сейшны. Главной сценой фестиваля станет центр Гейдара Алиева.</p><p>Билеты на основные концерты распроданы за неделю до открытия, что говорит о высоком интересе публики к событию.</p>',
        'types' => ['Новость', 'Фото'],
        'tags' => ['культура'],
        'is_featured' => false,
        'show_in_slider' => true,
        'img_category' => 'culture',
        'gallery' => 5,
    ],
    [
        'title' => 'Сборная по вольной борьбе завоевала пять медалей на международном турнире',
        'content' => '<p>Азербайджанские борцы продемонстрировали отличные результаты на престижном турнире в Стамбуле. Команда привезла домой две золотые, две серебряные и одну бронзовую медаль.</p><p>Особенно отличился молодой спортсмен Эльшад Гусейнов, который в финале победил действующего чемпиона мира.</p><p>Главный тренер сборной отметил, что это отличная подготовка перед предстоящим чемпионатом Европы.</p>',
        'types' => ['Новость', 'Видео'],
        'tags' => ['спорт'],
        'is_featured' => true,
        'show_in_slider' => true,
        'img_category' => 'sport',
    ],
    [
        'title' => 'Интервью с основателем успешного азербайджанского стартапа',
        'content' => '<p>Мы встретились с Фаридом Мамедовым, основателем компании TechVision, которая разработала инновационное приложение для образования.</p><p><strong>— Как вам пришла идея создать образовательную платформу?</strong></p><p>— Я видел, как сложно студентам находить качественные учебные материалы на азербайджанском языке. Мы решили создать платформу, которая объединит лучших преподавателей и студентов.</p><p><strong>— Какие планы на будущее?</strong></p><p>— Сейчас у нас 50 тысяч пользователей. В этом году планируем выйти на рынки соседних стран и привлечь инвестиции для масштабирования.</p>',
        'types' => ['Спецрепортаж'],
        'tags' => ['технологии', 'бизнес'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'tech',
    ],
    [
        'title' => 'Цифровизация здравоохранения: как технологии меняют медицину',
        'content' => '<p>Министерство здравоохранения запустило масштабную программу цифровизации медицинских услуг. Теперь пациенты могут записаться к врачу, получить результаты анализов и даже провести консультацию онлайн.</p><p>Электронная медицинская карта доступна в 80% государственных клиник. Система автоматически отслеживает историю болезни, назначения и результаты обследований.</p><p>Врачи отмечают, что это значительно ускоряет процесс диагностики и снижает количество ошибок при назначении лечения.</p><p>К концу года планируется интеграция системы со всеми частными клиниками страны.</p>',
        'types' => ['Статья'],
        'tags' => ['технологии', 'общество'],
        'is_featured' => true,
        'show_in_slider' => false,
        'img_category' => 'tech',
    ],
    [
        'title' => 'Фотопроект: Лица Азербайджана - портреты ремесленников',
        'content' => '<p>Фотограф Лейла Гасымова представила уникальный проект, посвященный мастерам традиционных ремесел. Более года она путешествовала по регионам, фотографируя кузнецов, гончаров, ковроткачей.</p><p>Каждый портрет — это история человека, который хранит и передает вековые традиции. В проекте участвовали 50 мастеров из 15 городов и районов.</p><p>Выставка откроется в Национальном музее искусств и будет доступна для посетителей в течение месяца.</p>',
        'types' => ['Фото'],
        'tags' => ['культура'],
        'is_featured' => false,
        'show_in_slider' => true,
        'img_category' => 'culture',
        'gallery' => 6,
    ],
    [
        'title' => 'Документальный фильм о возрождении Карабаха получил международную премию',
        'content' => '<p>Азербайджанский документальный фильм "Путь домой" удостоен специального приза на международном кинофестивале в Берлине. Лента рассказывает о восстановлении освобожденных территорий.</p><p>Режиссер Самир Алиев снимал фильм в течение двух лет, следя за судьбами семей, возвращающихся на родину. Особое внимание уделено работе строителей, археологов и экологов.</p><p>"Это история о надежде и возрождении. Я благодарен всем, кто помог создать этот фильм", - сказал режиссер на церемонии награждения.</p>',
        'types' => ['Видео'],
        'tags' => ['культура', 'мир'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'culture',
    ],
    [
        'title' => 'Подкаст "Голоса науки": беседа с нейробиологом о работе мозга',
        'content' => '<p>В новом выпуске подкаста мы говорим с доктором Ниджат Алиевой, ведущим нейробиологом и профессором Бакинского университета. Тема разговора — как работает наш мозг и можно ли улучшить память.</p><p>Доктор Алиева рассказывает о последних исследованиях в области нейропластичности и делится практическими советами по сохранению когнитивных функций.</p><p>Также обсуждаем влияние сна, питания и физических упражнений на работу мозга.</p>',
        'types' => ['Аудио'],
        'tags' => ['наука'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'tech',
    ],
    [
        'title' => 'Колонка: Почему важно развивать критическое мышление',
        'content' => '<p>В эпоху информационного изобилия умение отличать факты от мнений становится ключевым навыком. Критическое мышление помогает нам принимать взвешенные решения и не поддаваться манипуляциям.</p><p>Особенно важно обучать этому навыку детей и подростков. Школьная программа должна включать занятия по медиаграмотности и анализу информации.</p><p>Каждый из нас может развивать критическое мышление: задавать вопросы, проверять источники, сравнивать разные точки зрения.</p><p>Только образованное и думающее общество способно строить успешное будущее.</p>',
        'types' => ['Комментарий'],
        'tags' => ['общество'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'tech',
    ],
    [
        'title' => 'Нефтяной сектор показал рост производства на 8% за квартал',
        'content' => '<p>Государственная нефтяная компания опубликовала отчет за первый квартал. Добыча нефти выросла на 8% по сравнению с аналогичным периодом прошлого года.</p><p>Рост связан с запуском новых скважин на шельфе Каспийского моря и оптимизацией производственных процессов. Экспорт нефти также увеличился на 6%.</p><p>Компания инвестирует значительные средства в "зеленые" технологии и планирует сократить выбросы CO2 на 20% к 2030 году.</p>',
        'types' => ['Новость', 'Статья'],
        'tags' => ['экономика', 'бизнес'],
        'is_featured' => true,
        'show_in_slider' => false,
        'img_category' => 'news',
    ],
    [
        'title' => 'Азербайджанские физики участвуют в международном эксперименте ЦЕРН',
        'content' => '<p>Группа молодых физиков из Азербайджана присоединилась к международному проекту в Европейской организации ядерных исследований. Они будут работать над экспериментами на Большом адронном коллайдере.</p><p>Это первое участие азербайджанских ученых в столь масштабном научном проекте. Команда будет заниматься анализом данных и разработкой новых методов обработки информации.</p><p>Профессор Керим Мамедов, руководитель группы, отмечает: "Это уникальная возможность для наших молодых специалистов получить опыт работы на переднем крае науки."</p><p>Проект рассчитан на три года и финансируется совместно азербайджанским правительством и ЦЕРН.</p>',
        'types' => ['Новость', 'Спецрепортаж'],
        'tags' => ['наука', 'мир'],
        'is_featured' => true,
        'show_in_slider' => true,
        'img_category' => 'tech',
    ],
    [
        'title' => 'Международный шахматный турнир стартовал в Шамахы',
        'content' => '<p>В городе Шамахы начался международный шахматный турнир памяти выдающегося гроссмейстера Вугара Гашимова. В соревнованиях участвуют 12 сильнейших шахматистов мира.</p><p>Турнир проходит по круговой системе, каждый играет с каждым. Призовой фонд составляет 100 тысяч долларов.</p><p>Азербайджан представляют три гроссмейстера, которые демонстрируют уверенную игру. После трех туров наш шахматист Шахрияр Мамедъяров делит первое место с чемпионом мира.</p><p>Финал состоится через неделю, и все матчи транслируются онлайн.</p>',
        'types' => ['Новость', 'Фото', 'Видео'],
        'tags' => ['спорт'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'sport',
        'gallery' => 4,
    ],
    [
        'title' => 'Глубокий анализ: перспективы развития возобновляемой энергетики',
        'content' => '<p>Азербайджан обладает огромным потенциалом для развития возобновляемых источников энергии. Ветровые ресурсы Абшеронского полуострова, солнечная энергия в южных регионах, гидроэнергетика в горах — все это может стать основой для энергетической трансформации.</p><p>Правительство поставило амбициозную цель: к 2030 году 30% электроэнергии должно производиться из возобновляемых источников. Для этого создается специальная инфраструктура и привлекаются иностранные инвестиции.</p><p>Уже построено несколько солнечных и ветровых станций общей мощностью 500 МВт. Планируется увеличить эту цифру до 3000 МВт.</p><p>Эксперты считают, что развитие "зеленой" энергетики не только поможет сократить выбросы, но и создаст тысячи новых рабочих мест.</p><p>Однако есть и вызовы: необходимость модернизации электросетей, подготовка кадров, создание систем хранения энергии.</p>',
        'types' => ['Статья', 'Комментарий'],
        'tags' => ['экономика', 'технологии', 'инновации'],
        'is_featured' => true,
        'show_in_slider' => false,
        'img_category' => 'tech',
    ],
    [
        'title' => 'Репортаж: как создаются азербайджанские ковры мирового класса',
        'content' => '<p>Мы посетили мастерскую в Губе, где создаются уникальные ковры ручной работы. Мастерица Гюльнара ханум ткет ковры уже 45 лет и является обладательницей звания народного мастера.</p><p>Процесс создания одного ковра может занимать от нескольких месяцев до года. Сначала готовится пряжа, затем окрашивается натуральными красителями, и только потом начинается сам процесс ткачества.</p><p>"Каждый узел я завязываю с любовью. Ковер — это не просто изделие, это часть нашей культуры и истории", - говорит Гюльнара ханым.</p><p>Ее работы выставляются в музеях разных стран, а заказы поступают со всего мира.</p><p>В мастерской также учатся молодые девушки, которые хотят освоить это древнее искусство и продолжить традицию.</p>',
        'types' => ['Спецрепортаж', 'Фото'],
        'tags' => ['культура', 'общество'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'culture',
        'gallery' => 7,
    ],
    [
        'title' => 'Новая инициатива: в Баку появятся 50 "умных" остановок',
        'content' => '<p>Мэрия Баку объявила о запуске проекта по установке "умных" остановок общественного транспорта. Новые остановки будут оборудованы табло с информацией о прибытии транспорта, Wi-Fi, USB-зарядками и системой видеонаблюдения.</p><p>Первые 10 остановок установят на центральных улицах города уже в следующем месяце. К концу года их количество достигнет 50.</p><p>Также на остановках появятся сенсорные экраны с городской картой и информацией о достопримечательностях. Это особенно удобно для туристов.</p><p>Проект реализуется в рамках программы "Умный город" и финансируется из городского бюджета.</p>',
        'types' => ['Новость', 'Видео'],
        'tags' => ['технологии', 'общество'],
        'is_featured' => false,
        'show_in_slider' => false,
        'img_category' => 'city',
    ],
];

echo "Создаем 15 уникальных тестовых постов с изображениями...\n\n";

foreach ($testPosts as $index => $postData) {
    $num = $index + 1;
    echo "[$num/15] Создаем: {$postData['title']}\n";

    // Создаем пост
    $post = new Post();
    $post->title = $postData['title'];
    $post->slug = Str::slug($postData['title']) . '-' . rand(1000, 9999);
    $post->content = $postData['content'];
    $post->meta_title = $postData['title'];
    $post->meta_description = mb_substr(strip_tags($postData['content']), 0, 155);

    // Случайная категория
    $post->category_id = $categories->random()->id;

    // Случайный автор
    $post->author_id = $authors->random()->id;

    // Статистика
    $post->views = rand(150, 5000);
    $post->read_time = rand(3, 12);

    // Статусы
    $post->is_featured = $postData['is_featured'];
    $post->is_published = true;
    $post->published_at = Carbon::now()->subDays(rand(0, 30));
    $post->show_on_homepage = true;
    $post->show_in_slider = $postData['show_in_slider'];

    $post->save();

    // Привязываем типы
    $typeIds = [];
    foreach ($postData['types'] as $typeName) {
        $type = $postTypes->firstWhere('name', $typeName);
        if ($type) {
            $typeIds[] = $type->id;
        }
    }
    if (!empty($typeIds)) {
        $post->types()->attach($typeIds);
    }

    // Привязываем теги
    $postTags = [];
    foreach ($postData['tags'] as $tagName) {
        $tag = collect($tags)->firstWhere('name', $tagName);
        if ($tag) {
            $postTags[] = $tag->id;
        }
    }
    if (!empty($postTags)) {
        $post->tags()->attach($postTags);
    }

    // Привязываем к категориям (many-to-many)
    $randomCategories = $categories->random(rand(1, 2))->pluck('id')->toArray();
    $post->categories()->attach($randomCategories);

    // Добавляем главное изображение
    $imageCategory = $postData['img_category'];
    $image = $images[$imageCategory][array_rand($images[$imageCategory])];
    $fileName = "featured-{$post->id}-" . Str::slug($image['name']) . ".jpg";

    $mediaId = DB::table('media')->insertGetId([
        'model_type' => 'App\\Models\\Post',
        'model_id' => $post->id,
        'uuid' => Str::uuid(),
        'collection_name' => 'featured',
        'name' => $image['name'],
        'file_name' => $fileName,
        'mime_type' => 'image/jpeg',
        'disk' => 'public',
        'conversions_disk' => 'public',
        'size' => rand(800000, 2500000),
        'manipulations' => json_encode([]),
        'custom_properties' => json_encode([
            'width' => $image['width'],
            'height' => $image['height'],
        ]),
        'generated_conversions' => json_encode([
            'thumb' => true,
            'medium' => true,
            'large' => true,
        ]),
        'responsive_images' => json_encode([]),
        'order_column' => 1,
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    $post->featured_media_id = $mediaId;
    $post->featured_image = "storage/media/{$post->id}/{$fileName}";
    $post->save();

    echo "  ✓ Типы: " . implode(', ', $postData['types']) . "\n";
    echo "  ✓ Теги: " . implode(', ', $postData['tags']) . "\n";
    echo "  ✓ Главное фото: {$image['name']}\n";

    // Добавляем галерею для фото-постов
    if (isset($postData['gallery'])) {
        $galleryCount = $postData['gallery'];
        for ($i = 0; $i < $galleryCount; $i++) {
            $galleryImg = $images[$imageCategory][array_rand($images[$imageCategory])];
            $galleryFileName = "gallery-{$post->id}-" . ($i + 1) . ".jpg";

            DB::table('media')->insert([
                'model_type' => 'App\\Models\\Post',
                'model_id' => $post->id,
                'uuid' => Str::uuid(),
                'collection_name' => 'gallery',
                'name' => $galleryImg['name'],
                'file_name' => $galleryFileName,
                'mime_type' => 'image/jpeg',
                'disk' => 'public',
                'conversions_disk' => 'public',
                'size' => rand(500000, 3000000),
                'manipulations' => json_encode([]),
                'custom_properties' => json_encode([
                    'width' => $galleryImg['width'],
                    'height' => $galleryImg['height'],
                ]),
                'generated_conversions' => json_encode([]),
                'responsive_images' => json_encode([]),
                'order_column' => $i + 1,
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }
        echo "  ✓ Галерея: {$galleryCount} фото\n";
    }

    echo "\n";
}

echo "✓ Создано 15 уникальных постов!\n";
