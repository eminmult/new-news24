# FastCGI Cache Path
fastcgi_cache_path /var/cache/nginx/fastcgi levels=1:2 keys_zone=FASTCGICACHE:100m inactive=60m max_size=1g;
fastcgi_cache_key "$scheme$request_method$host$request_uri";

server_tokens off;
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=admin:10m rate=10r/m;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

server { listen 80 default_server; listen [::]:80 default_server; server_name _; return 444; }
server { listen 443 ssl http2 default_server; listen [::]:443 ssl http2 default_server; server_name _; ssl_certificate /etc/nginx/ssl/fullchain.pem; ssl_certificate_key /etc/nginx/ssl/privkey.pem; return 444; }
server { listen 80; listen [::]:80; server_name news24.az new.news24.az www.news24.az edm.news24.az; location ^~ /.well-known/acme-challenge/ { root /var/www/html/public; allow all; } location / { return 301 https://$server_name$request_uri; } }
server { listen 443 ssl http2; listen [::]:443 ssl http2; server_name new.news24.az www.news24.az; ssl_certificate /etc/nginx/ssl/fullchain.pem; ssl_certificate_key /etc/nginx/ssl/privkey.pem; ssl_protocols TLSv1.2 TLSv1.3; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; return 301 https://news24.az$request_uri; }

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name news24.az;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    limit_req zone=general burst=50 nodelay;
    limit_conn conn_limit 20;

    root /var/www/html/public;
    index index.php;
    charset utf-8;
    client_max_body_size 50M;

    # ТОЛЬКО ДВЕ проверки: POST и admin/api
    set $skip_cache 0;
    if ($request_method = POST) { set $skip_cache 1; }
    if ($request_uri ~* "/admin|/api") { set $skip_cache 1; }

    location ~* \.(jpg|jpeg|png|gif|ico|webp|svg|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    location ~* \.(css|js)$ {
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
        try_files $uri =404;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    location ~ \.php$ {
        fastcgi_pass php-fpm-new1:9000;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param HTTPS on;

        fastcgi_cache FASTCGICACHE;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_valid 200 5m;
        fastcgi_ignore_headers Cache-Control Set-Cookie;
        fastcgi_cache_use_stale error timeout updating invalid_header http_500;
        fastcgi_cache_background_update on;
        fastcgi_cache_lock on;
        
        add_header X-FastCGI-Cache $upstream_cache_status always;
    }

    location ~ /\.(?!well-known).* { deny all; }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name edm.news24.az;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    root /var/www/html/public;
    index index.php;
    charset utf-8;
    client_max_body_size 50M;

    location / { try_files $uri $uri/ /index.php?$query_string; }
    location ~ \.php$ {
        fastcgi_pass php-fpm-new1:9000;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param HTTPS on;
    }
}
